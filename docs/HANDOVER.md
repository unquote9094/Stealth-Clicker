# 🔄 세션 핸드오버 문서

> **생성일**: 2026-01-03 11:16 (Step 600+)
> **프로젝트**: Stealth-Clicker (뉴토끼 자동화)

---

## 📋 현재 상태 요약

| 항목 | 상태 |
|:---|:---|
| 광산 채굴 | ✅ 동작 중 |
| 몬스터 레이드 | ⚠️ 포인트 파싱 문제 해결 중 |
| 통합 스케줄러 | ✅ 동작 중 |
| 터미널 UI | ✅ 동작 중 |

---

## ✅ 이번 세션 완료 작업

### 1. 광산 채굴 (`MineGame.js`)

- [x] 광산 인식 버그 수정 (종료일 기반)
- [x] 채굴 순이익 계산: `보상 - 1000` (배거288 사용료)
- [x] 채굴 실패 손해 계산: `1000 - 환불`
- [x] 경고창 딜레이 1-3초 추가

### 2. 몬스터 레이드 (`MonsterRaid.js`)

- [x] 살아있는 레이드 판별 수정 (종료일 기반)
- [x] URL 기반 중복 공격 방지
- [x] 캡차 감지 시 스킵
- [x] Dialog 처리 순서 개선 (최신 커밋)

### 3. 통합 스케줄러 (`Orchestrator.js`)

- [x] 대기 중 레이드 시간 체크 (1분마다)
- [x] 레이드 전후 3-5초 딜레이
- [x] 광산 이름 하드코딩 제거

### 4. 설정 (`config.js`)

- [x] 닉네임 대괄호 제거: `살려줘요ㅠㅠ`

---

## ⚠️ 현재 진행 중인 문제

### 레이드 포인트 10점 고정 문제

**증상**: 터미널 UI에서 레이드 포인트가 항상 10으로 표시됨

**원인 분석 (해결 시도 중)**:

1. Dialog 핸들러가 즉시 accept() 호출 → 파싱 전에 닫힘
2. 타이밍 문제로 `lastAlertMessage`가 null

**최신 해결책** (커밋 `ca33876`):

```javascript
// 새로운 처리 순서
1. 버튼 클릭
2. 경고창 뜰 때까지 대기 (최대 10초)
3. 메시지 파싱 + 포인트 계산
4. 확인 버튼 클릭 (2-4초 딜레이)
```

**핵심 변경**:

- `_registerAlertHandler()`: 메시지만 저장, accept 안 함
- `_acceptDialog()`: 별도 함수로 확인 클릭
- `attackOnce()`: 순서대로 처리

**테스트 필요**: 다음 레이드 시간(XX:10 또는 XX:40)에 확인

---

## 📂 핵심 파일 구조

```
src/
├── actions/
│   ├── MineGame.js      # 광산 채굴 (완료)
│   └── MonsterRaid.js   # 몬스터 레이드 (포인트 파싱 확인 필요)
├── core/
│   ├── Orchestrator.js  # 통합 스케줄러
│   ├── BrowserEngine.js # 브라우저 제어
│   └── HumanMouse.js    # 자연스러운 마우스
├── config/
│   └── config.js        # 설정 (닉네임 등)
└── utils/
    ├── TerminalUI.js    # 터미널 UI
    └── logger.js        # 로그
```

---

## 🔧 다음 세션 우선 작업

### 1순위: 레이드 포인트 파싱 확인

```bash
node auto-run.js
```

- 10/40분에 레이드 공격 시 로그 확인
- `[Alert 감지]` 로그에 포인트 정보 있는지 확인
- 터미널 UI에 실제 포인트 표시되는지 확인

### 2순위: 아직 미구현

- [ ] 랜덤 페이지 방문 (대기 중 커뮤니티/웹툰)
- [ ] 마우스 움직임 (대기 중)
- [ ] 클라우드플레어 세션 관리 (4시간)

---

## 📝 테스트 명령어

```bash
# 통합 테스트
node auto-run.js

# 광산만 테스트
node auto-mine.js

# 레이드만 테스트
node raid-test.js
```

---

## 🔗 최근 커밋

| 커밋 | 내용 |
|:---|:---|
| `ca33876` | 레이드 순서대로 처리 (dialog 분리) |
| `72c06e3` | 공격 후 대기 1.5→5초 |
| `5c10f2a` | alert에서 직접 포인트 파싱 |
| `ec2b41e` | URL 기반 중복 방지 + 캡차 감지 |
| `63f815e` | 채굴 순이익 계산 + 페이지 이동 딜레이 |

---

## ⚡ 중요 규칙 (절대 잊지 말 것)

1. **레이드는 시간대당 1회만**: 10분~20분, 40분~50분
2. **첫 공격만**: 두 번째부터 캡차 있음
3. **배거288 사용료**: 1000점 (보상에서 차감)
4. **클플 세션**: 4시간, 과도한 요청 시 403밴
5. **사람처럼**: 모든 동작에 2-5초 딜레이

---

## 📌 사용자 닉네임

```
살려줘요ㅠㅠ
```

(대괄호 없음!)
